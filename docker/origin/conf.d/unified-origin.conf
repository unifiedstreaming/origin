# builtin modules
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule ssl_module modules/mod_ssl.so
# Unified Streaming modules
<IfModule !unified_filter_module>
  LoadModule unified_filter_module /usr/lib/apache2/mod_unified_filter.so
</IfModule>
LoadModule smooth_streaming_module modules/mod_smooth_streaming.so
LoadModule unified_s3_auth_module modules/mod_unified_s3_auth.so

AddHandler smooth-streaming.extensions .ism .isml

ServerName unified-origin

UspLicenseKey /etc/usp-license.key

LogFormat '${LOG_FORMAT}' log_format


<VirtualHost 0.0.0.0:80>
# don't log kubernetes probes
  SetEnvIf User-Agent "kube-probe" dontlog
  CustomLog /dev/stdout log_format env=!dontlog
  ErrorLog /dev/stderr

  LogLevel ${LOG_LEVEL}
  SSLProxyEngine on

  DocumentRoot /var/www/unified-origin

  Header set Access-Control-Allow-Headers "origin, range"
  Header set Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
  Header set Access-Control-Allow-Origin "*"
  Header set Access-Control-Expose-Headers "Server,range"

  # Enable Origin and use subrequests instead of libcurl
  <Location />
    UspHandleIsm on
    UspEnableSubreq on
  </Location>

  # Manifest Edit configuration
  UspFilterDefine usp_filter_manifest_edit mode=output \
  cmd="/usr/bin/manifest_edit -v 1 -o stdout: --python_pipeline_path=/etc/manifest-edit stdin:"

  # The default setting is to invoke the usp_filter_manifest_edit filter for any
  # URL ending in .mpd or .m3u8, with a query argument 'python_pipeline_config'.
  <LocationMatch ".*\.(mpd|m3u8)$">
    <If "%{QUERY_STRING} =~ /python_pipeline_config=/">
        UspFilterOptions LogStderr Onfail=abort
        SetOutputFilter usp_filter_manifest_edit
    </If>
  </LocationMatch>
  
  # The following also matches .mpd or .m3u8 manifests when URL rewriting is
  # active, e.g. for IsmProxyPass.
  <LocationMatch ".*\.ism[l]?$">
    <If "%{QUERY_STRING} =~ /python_pipeline_config=/">
        <If "%{QUERY_STRING} =~ /file=.*\.(mpd|m3u8)$/">
        UspFilterOptions LogStdErr Onfail=abort
        SetOutputFilter usp_filter_manifest_edit
        </If>
    </If>
  </LocationMatch>

  # remote storage configuration
  <IfDefine REMOTE_STORAGE_URL>
    <Location "/${REMOTE_PATH}/">
      IsmProxyPass "${REMOTE_STORAGE_URL}"
    </Location>

    <Proxy "${REMOTE_STORAGE_URL}">
      ProxySet connectiontimeout=5 enablereuse=on keepalive=on retry=0 timeout=30 ttl=300
      RequestHeader unset Accept-Encoding
      <IfDefine S3_ACCESS_KEY>
        S3AccessKey ${S3_ACCESS_KEY}
      </IfDefine>
      <IfDefine S3_SECRET_KEY>
        S3SecretKey ${S3_SECRET_KEY}
      </IfDefine>
      <IfDefine S3_REGION>
        S3Region ${S3_REGION}
      </IfDefine>
    </Proxy>
  </IfDefine>

</VirtualHost>

<Directory /var/www/unified-origin>
  Require all granted
</Directory>

# Optional REST API for publishing point management
<IfDefine REST_API_PORT>
  Listen ${REST_API_PORT}
  <VirtualHost 0.0.0.0:${REST_API_PORT}>
    CustomLog /dev/stdout log_format
    ErrorLog /dev/stderr
    LogLevel ${LOG_LEVEL}

    DocumentRoot /var/www/unified-origin

    # Enable REST API
    <Location />
      UspHandleApi on
    </Location>
  </VirtualHost>
</IfDefine>